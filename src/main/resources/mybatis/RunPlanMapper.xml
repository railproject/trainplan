<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="org.railway.com.trainplan.repository.mybatis.RunPlanDao">

    <resultMap id="runPlan" type="org.railway.com.trainplan.entity.RunPlan">
        <id property="planTrainId" column="PLAN_TRAIN_ID"/>
        <result property="planTrainSign" column="PLAN_TRAIN_SIGN"/>
        <result property="planCrossId" column="PLAN_CROSS_ID"/>
        <result property="preTrainId" column="PRE_TRAIN_ID"/>
        <result property="nextTrainId" column="NEXT_TRAIN_ID"/>
        <result property="runDate" column="RUN_DATE"/>
        <result property="trainNbr" column="TRAIN_NBR"/>
        <result property="startDateTime" column="START_TIME"/>
        <result property="endDateTime" column="END_TIME"/>
        <result property="startBureauShortName" column="START_BUREAU"/>
        <result property="startBureauFullName" column="START_BUREAU_FULL"/>
        <result property="startStn" column="START_STN"/>
        <result property="endBureauShortName" column="END_BUREAU"/>
        <result property="endBureauFullName" column="END_BUREAU_FULL"/>
        <result property="endStn" column="END_STN"/>
        <result property="passBureau" column="PASS_BUREAU"/>
        <result property="trainScope" column="TRAIN_SCOPE"/>
        <result property="trainTypeId" column="TRAIN_TYPE_ID"/>
        <result property="highLineFlag" column="HIGHLINE_FLAG"/>
        <result property="baseChartId" column="BASE_CHART_ID"/>
        <result property="baseTrainId" column="BASE_TRAIN_ID"/>
        <result property="hightLineRule" column="HIGHLINE_RULE"/>
        <result property="commonLineRule" column="COMMONLINE_RULE"/>
        <result property="appointWeek" column="APPOINT_WEEK"/>
        <result property="appointDay" column="APPOINT_DAY"/>
        <result property="dayGap" column="DAY_GAP"/>
        <result property="spareFlag" column="SPARE_FLAG"/>
        <result property="spareApplyFlag" column="SPARE_APPLY_FLAG"/>
        <result property="createType" column="CREAT_TYPE"/>
        <result property="createDateTime" column="CREAT_TIME"/>
        <result property="checkLev1Type" column="CHECK_LEV1_TYPE"/>
        <result property="checkLev2Type" column="CHECK_LEV2_TYPE"/>
        <result property="dailyPlanTimes" column="DAILYPLAN_TIMES"/>
    </resultMap>

    <!-- 根据日期和所属局查询客运计划列表 -->
	<select id="findRunPlan" parameterType="map" resultType="map">
        SELECT PT.PLAN_TRAIN_ID AS PLAN_TRAIN_ID, PT.TRAIN_NBR AS TRAIN_NBR, PT.START_STN AS START_STN, PT.END_STN AS END_STN, PT.RUN_DATE AS RUN_DATE,
        TO_CHAR(PT.START_TIME, 'mm-dd hh24:mi') AS START_TIME, TO_CHAR(PT.END_TIME, 'mm-dd hh24:mi') AS END_TIME,
        CASE PT.DAILYPLAN_FLAG WHEN '0' THEN '已上图' WHEN '1' THEN '未上图' ELSE '未知' END AS DAILYPLAN_FLAG, TO_CHAR(PT.DAILYPLAN_TIME, 'mm-dd hh24:mi') AS DAILYPLAN_TIME, PT.DAILYPLAN_ID AS DAILYPLAN_ID,
        (CASE PT.HIGHLINE_FLAG WHEN 1 THEN '高线' WHEN 2 THEN '混合' WHEN 0 THEN '普线' ELSE '未知' END) AS HIGHLINE_FLAG,
        PT.CHECK_LEV1_TYPE AS CHECK_LEV1_TYPE, PT.CHECK_LEV2_TYPE AS CHECK_LEV2_TYPE,
        CASE PT.SPARE_FLAG WHEN 1 THEN '开行' WHEN 2 THEN '备用' WHEN 0 THEN '停运' ELSE '未知' END AS SPARE_FLAG,
        CASE PT.CREAT_TYPE WHEN 0 THEN '基本图初始化' WHEN 1 THEN '基本图混动' WHEN 2 THEN '文件电报' WHEN 3 THEN '命令' WHEN 4 THEN '人工添加' ELSE '未知' END AS CREAT_TYPE,
        CASE WHEN PT.CHECK_LEV1_BUREAU LIKE '%${bureau}%' THEN 1 ELSE 0 END AS LEV1_CHECKED, CASE WHEN PT.CHECK_LEV2_BUREAU LIKE '%${bureau}%' THEN 1 ELSE 0 END AS LEV2_CHECKED
        FROM PLAN_TRAIN PT
        LEFT JOIN JHPT_RJH.M_TRAINLINE TL ON PT.DAILYPLAN_ID = TL.ID
        WHERE PT.START_BUREAU = '${bureau}' AND PT.RUN_DATE = '${date}' ORDER BY PT.TRAIN_NBR
	</select>

    <!-- 校验列车主体信息： 客运计划vs日计划 -->
    <select id="checkTrainInfo" parameterType="string" resultType="map">
        SELECT CASE WHEN PT.TRAIN_NBR = TL.NAME THEN 1 ELSE 0 END AS TRAIN_NAME,
        CASE WHEN PT.START_BUREAU_FULL = TL.SOURCE_BUREAU_NAME THEN 1 ELSE 0 END AS START_BUREAU,
        CASE WHEN PT.END_BUREAU_FULL = TL.TARGET_BUREAU_NAME THEN 1 ELSE 0 END AS END_BUREAU,
        CASE WHEN PT.START_STN = TL.SOURCE_NODE_NAME THEN 1 ELSE 0 END AS START_STN,
        CASE WHEN PT.END_STN = TL.TARGET_NODE_NAME THEN 1 ELSE 0 END AS END_STN,
        CASE WHEN TO_CHAR(PT.START_TIME, 'yyyy-mm-dd hh24:mi') = TO_CHAR(TL.SOURCE_TIME, 'yyyy-mm-dd hh24:mi') THEN 1 ELSE 0 END AS START_TIME,
        CASE WHEN TO_CHAR(PT.END_TIME, 'yyyy-mm-dd hh24:mi') = TO_CHAR(TL.TARGET_TIME, 'yyyy-mm-dd hh24:mi') THEN 1 ELSE 0 END AS END_TIME
        FROM PLAN_TRAIN PT LEFT JOIN JHPT_RJH.M_TRAINLINE TL ON PT.DAILYPLAN_ID = TL.ID
        WHERE PT.PLAN_TRAIN_ID = '${planId}' AND TL.ID = '${lineId}'
    </select>

    <!-- 根据计划id查询计划时刻表 -->
    <select id="findPlanTimeTableByPlanId" parameterType="string" resultType="map">
        SELECT PTS.STN_SORT AS STN_INDEX, PTS.STN_NAME AS STN_NAME, PTS.STN_BUREAU_FULL AS BUREAU,
        PTS.TRACK_NAME AS TRACK_NAME, TO_CHAR(PTS.ARR_TIME, 'yyyy-mm-dd hh24:mi') AS ARR_TIME,
        TO_CHAR(PTS.DPT_TIME, 'yyyy-mm-dd hh24:mi') AS DPT_TIME
        FROM PLAN_TRAIN_STN PTS
        WHERE PTS.PLAN_TRAIN_ID = #{planId}
        ORDER BY PTS.STN_SORT
    </select>

    <!-- 根据计划id查询计划主体信息 -->
    <select id="findPlanInfoByPlanId" parameterType="string" resultType="map">
        SELECT PT.PLAN_TRAIN_ID, PT.TRAIN_NBR AS TRAIN_NAME, PT.START_BUREAU_FULL AS START_BUREAU, PT.END_BUREAU_FULL AS END_BUREAU, PT.START_STN AS START_STN,
        PT.END_STN AS END_STN, TO_CHAR(PT.START_TIME, 'yyyy-mm-dd hh24:mi') AS START_TIME, TO_CHAR(PT.END_TIME, 'yyyy-mm-dd hh24:mi') AS END_TIME, PT.PASS_BUREAU AS PASS_BUREAU,
        PT.CHECK_LEV1_TYPE AS CHECK_LEV1_TYPE, PT.CHECK_LEV1_BUREAU AS CHECK_LEV1_BUREAU, PT.CHECK_LEV2_TYPE AS CHECK_LEV2_TYPE, PT.CHECK_LEV2_BUREAU AS CHECK_LEV2_BUREAU
        FROM PLAN_TRAIN PT WHERE PT.PLAN_TRAIN_ID = #{planId}
    </select>

    <insert id="addCheckHis" parameterType="java.util.List">
        INSERT INTO DAILYPLAN_CHECK(DAILYPLAN_CHECK_ID,DAILYPLAN_ID,PLAN_TRAIN_ID,CHECK_PEOPLE,CHECK_TIME,CHECK_DEPT,CHECK_BUREAU,CHECK_TYPE)
        <foreach collection="list" item="item" index="index" open="(" separator="UNION ALL" close=")">
            SELECT #{item.id, jdbcType=VARCHAR}, #{item.lineId, jdbcType=VARCHAR}, #{item.planId, jdbcType=VARCHAR}, #{item.people, jdbcType=VARCHAR}, sysdate, #{item.dept, jdbcType=VARCHAR},
            #{item.bureau, jdbcType=VARCHAR}, #{item.checkType, jdbcType=NUMERIC} FROM DUAL
        </foreach>
    </insert>

    <select id="findPlanInfoListByPlanId" parameterType="java.util.List" resultType="map">
        SELECT PT.PLAN_TRAIN_ID AS PLAN_TRAIN_ID, PT.TRAIN_NBR AS TRAIN_NAME, PT.START_BUREAU_FULL AS START_BUREAU, PT.END_BUREAU_FULL AS END_BUREAU, PT.START_STN AS START_STN,
        PT.END_STN AS END_STN, TO_CHAR(PT.START_TIME, 'yyyy-mm-dd hh24:mi') AS START_TIME, TO_CHAR(PT.END_TIME, 'yyyy-mm-dd hh24:mi') AS END_TIME, PT.PASS_BUREAU AS PASS_BUREAU,
        PT.CHECK_LEV1_TYPE AS CHECK_LEV1_TYPE, PT.CHECK_LEV1_BUREAU AS CHECK_LEV1_BUREAU, PT.CHECK_LEV2_TYPE AS CHECK_LEV2_TYPE, PT.CHECK_LEV2_BUREAU AS CHECK_LEV2_BUREAU
        FROM PLAN_TRAIN PT WHERE PT.PLAN_TRAIN_ID in
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <update id="updateCheckInfo" parameterType="map">
        UPDATE PLAN_TRAIN PT SET PT.CHECK_LEV1_TYPE = #{lev1Type}, PT.CHECK_LEV1_BUREAU = #{lev1Bureau}, PT.CHECK_LEV2_TYPE = #{lev2Type}, PT.CHECK_LEV2_BUREAU = #{lev2Bureau} WHERE PT.PLAN_TRAIN_ID = #{planId}
    </update>

    <insert id="addRunPlan" parameterMap="runPlan">
        INSERT INTO DAILYPLAN_CHECK(PLAN_TRAIN_ID, PLAN_TRAIN_SIGN,PLAN_CROSS_ID,PRE_TRAIN_ID,NEXT_TRAIN_ID,RUN_DATE,TRAIN_NBR,START_TIME,END_TIME,
        START_BUREAU,START_BUREAU_FULL,START_STN,END_BUREAU,END_BUREAU_FULL,END_STN,PASS_BUREAU,TRAIN_TYPE_ID,HIGHLINE_FLAG,BASE_CHART_ID,BASE_TRAIN_ID,
        HIGHLINE_RULE,COMMONLINE_RULE,APPOINT_WEEK,APPOINT_DAY,DAY_GAP,SPARE_FLAG,SPARE_APPLY_FLAG,CREAT_TYPE,CREAT_TIME,CHECK_LEV1_TYPE,CHECK_LEV2_TYPE,
        DAILYPLAN_TIMES) VALUES(
            #{planTrainId}, #{planTrainSign}, #{planCrossId}, #{preTrainId}, #{nextTrainId}, #{runDate}, #{trainNbr}, #{startDateTime}, #{endDateTime},
            #{startBureauShortName}, #{startBureauFullName}, #{startStn}, #{endBureauShortName}, #{endBureauFullName}, #{endStn}, #{passBureau}, #{trainScope},
            #{trainTypeId}, #{highLineFlag}, #{baseChartId}, #{baseTrainId}, #{hightLineRule}, #{commonLineRule}, #{appointWeek}, #{appointDay}, #{dayGap},
            #{spareFlag}, #{spareApplyFlag}, #{createType}, #{createDateTime}, #{checkLev1Type}, #{checkLev2Type}, #{dailyPlanTimes}
        )
    </insert>

</mapper> 
