<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="org.railway.com.trainplan.repository.mybatis.RunPlanDao">

	<select id="findRunPlan" parameterType="map" resultType="map">
        SELECT PT.PLAN_TRAIN_ID AS PLAN_TRAIN_ID, PT.TRAIN_NBR AS TRAIN_NBR, PT.START_STN AS START_STN, PT.END_STN AS END_STN, PT.RUN_DATE AS RUN_DATE,
        TO_CHAR(PT.START_TIME, 'mm-dd hh24:mi') AS START_TIME, TO_CHAR(PT.END_TIME, 'mm-dd hh24:mi') AS END_TIME,
        CASE PT.DAILYPLAN_FLAG WHEN '0' THEN '已上图' WHEN '1' THEN '未上图' ELSE '未知' END AS DAILYPLAN_FLAG, TO_CHAR(PT.DAILYPLAN_TIME, 'mm-dd hh24:mi') AS DAILYPLAN_TIME, PT.DAILYPLAN_ID AS DAILYPLAN_ID,
        (CASE PT.HIGHLINE_FLAG WHEN 1 THEN '高线' WHEN 2 THEN '混合' WHEN 0 THEN '普线' ELSE '未知' END) AS HIGHLINE_FLAG,
        PT.CHECK_TYPE_LEV1 AS CHECK_TYPE_LEV1, PT.CHECK_TYPE_LEV2 AS CHECK_TYPE_LEV2,
        CASE PT.SPARE_FLAG WHEN 1 THEN '开行' WHEN 2 THEN '备用' WHEN 0 THEN '停运' ELSE '未知' END AS SPARE_FLAG,
        CASE PT.CREAT_TYPE WHEN 0 THEN '基本图初始化' WHEN 1 THEN '基本图混动' WHEN 2 THEN '文件电报' WHEN 3 THEN '命令' WHEN 4 THEN '人工添加' ELSE '未知' END AS CREAT_TYPE
        FROM PLAN_TRAIN PT
        LEFT JOIN JHPT_RJH.M_TRAINLINE TL ON PT.DAILYPLAN_ID = TL.ID
        WHERE PT.START_BUREAU = '${bureau}' AND PT.RUN_DATE = '${date}' ORDER BY PT.TRAIN_NBR
	</select>

    <select id="findRunPlanStnByTrain" parameterType="string" resultType="map">
        SELECT T.PLAN_TRAIN_STN_ID AS PLAN_TRAIN_STN_ID, T.STN_NAME AS STN_NAME,
        T.ARR_TIME AS ARR_TIME, T.DPT_TIME AS DPT_TIME, T.TRACK_NAME AS TRACK_NAME,
        T.PSG_FLG AS PSG_FLG, T.STN_BUREAU AS STN_BUREAU
        FROM PLAN_TRAIN_STN T WHERE T.PLAN_TRAIN_ID = #{train_id} ORDER BY T.STN_SORT
    </select>

    <select id="findRunPlanByTrainIds" parameterType="string" resultType="map">
        SELECT PT.TRAIN_NBR AS TRAIN_NBR, PT.START_STN AS START_STN, PT.END_STN AS END_STN, T.PLAN_TRAIN_STN_ID AS PLAN_TRAIN_STN_ID, T.STN_NAME AS STN_NAME,
        T.ARR_TIME AS ARR_TIME, T.DPT_TIME AS DPT_TIME, T.TRACK_NAME AS TRACK_NAME, PT.RUN_DATE AS RUN_DATE,
        T.PSG_FLG AS PSG_FLG, T.STN_BUREAU AS STN_BUREAU, T.RUN_DAYS AS RUN_DAYS
        FROM PLAN_TRAIN PT INNER JOIN PLAN_TRAIN_STN T ON PT.PLAN_TRAIN_ID = T.PLAN_TRAIN_ID
        WHERE T.PLAN_TRAIN_ID in (#{train_ids}) ORDER BY PT.TRAIN_NBR, T.STN_SORT
    </select>

    <select id="findPlanLineSTNs" parameterType="string" resultType="map">
        SELECT PTS.STN_NAME AS STN_NAME FROM PLAN_TRAIN_STN PTS WHERE PTS.PLAN_TRAIN_ID = #{train_ids} ORDER BY PTS.STN_SORT
    </select>

    <select id="checkTrainInfo" parameterType="string" resultType="map">
        SELECT CASE WHEN PT.TRAIN_NBR = TL.NAME THEN 1 ELSE 0 END AS TRAIN_NAME,
        CASE WHEN PT.START_BUREAU_FULL = TL.SOURCE_BUREAU_NAME THEN 1 ELSE 0 END AS START_BUREAU,
        CASE WHEN PT.END_BUREAU_FULL = TL.TARGET_BUREAU_NAME THEN 1 ELSE 0 END AS END_BUREAU,
        CASE WHEN PT.START_STN = TL.SOURCE_NODE_NAME THEN 1 ELSE 0 END AS START_STN,
        CASE WHEN PT.END_STN = TL.TARGET_NODE_NAME THEN 1 ELSE 0 END AS END_STN,
        CASE WHEN TO_CHAR(PT.START_TIME, 'yyyy-mm-dd hh24:mi') = TO_CHAR(TL.SOURCE_TIME, 'yyyy-mm-dd hh24:mi') THEN 1 ELSE 0 END AS START_TIME,
        CASE WHEN TO_CHAR(PT.END_TIME, 'yyyy-mm-dd hh24:mi') = TO_CHAR(TL.TARGET_TIME, 'yyyy-mm-dd hh24:mi') THEN 1 ELSE 0 END AS END_TIME
        FROM PLAN_TRAIN PT LEFT JOIN JHPT_RJH.M_TRAINLINE TL ON PT.DAILYPLAN_ID = TL.ID
        WHERE PT.PLAN_TRAIN_ID = '${planId}' AND TL.ID = '${lineId}'
    </select>

    <select id="findPlanTimeTableByPlanId" parameterType="string" resultType="map">
        SELECT PTS.STN_SORT AS STN_INDEX, PTS.STN_NAME AS STN_NAME, PTS.STN_BUREAU_FULL AS BUREAU,
        PTS.TRACK_NAME AS TRACK_NAME, TO_CHAR(PTS.ARR_TIME, 'yyyy-mm-dd hh24:mi') AS ARR_TIME,
        TO_CHAR(PTS.DPT_TIME, 'yyyy-mm-dd hh24:mi') AS DPT_TIME
        FROM PLAN_TRAIN_STN PTS
        WHERE PTS.PLAN_TRAIN_ID = #{planId}
        ORDER BY PTS.STN_SORT
    </select>
</mapper> 
