<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="trainInfoDao"> 

    <select id="getTrainsAndTimesCount" parameterType="map" resultType="map">
      select count(*) as count
			from
			(
			select t2.*
			  from (SELECT t.parent_id,
			  t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS DPT_TIME,
			               0 as run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_SITEM T
			        UNION all
			        SELECT t.parent_id,
			          t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.SOURCE_TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TARGET_TIME, 'hh24:mi:SS') AS DPT_TIME,
			               t.relative_source_time_day run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_RITEM T
			        UNION all
			        SELECT t.parent_id,
			          t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS DPT_TIME,
			               t.relative_time_day run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_TITEM T) t2,
			       (select id
			          from JHPT_RJH.m_trainlinetemp t
			         where t.scheme_id = ${chartId} and t.OPERATION=${operation}) t1
			 where t1.id = t2.parent_id order by parent_id,stn_index 
			 )
    </select>
    
    
    <select id="getTrainsAndTimesForPage" parameterType="map" resultType="map">
       select *   from (
            select ROWNUM AS num, m.* from
			(
			select t2.*
			  from (SELECT t.parent_id,
			  t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS DPT_TIME,
			               0 as run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_SITEM T
			        UNION all
			        SELECT t.parent_id,
			          t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.SOURCE_TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TARGET_TIME, 'hh24:mi:SS') AS DPT_TIME,
			               t.relative_source_time_day run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_RITEM T
			        UNION all
			        SELECT t.parent_id,
			          t.parent_name,
			               T.CHILD_INDEX AS STN_INDEX,
			               T.NAME AS STN_NAME,
			               T.Bureau_Shortname AS BUREAU,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS ARR_TIME,
			               TO_CHAR(T.TIME, 'hh24:mi:SS') AS DPT_TIME,
			               t.relative_time_day run_days,
			               T.TRACK_NAME AS TRACK_NAME
			          FROM JHPT_RJH.M_TRAINLINETEMP_SCHEDULE_TITEM T) t2,
			       (select id
			          from JHPT_RJH.m_trainlinetemp t
			         where t.scheme_id = ${chartId} and t.OPERATION=${operation}) t1
			         where t1.id = t2.parent_id order by parent_id,stn_index 
			        )  m ) where num >=#{rownumstart} AND num &lt;=#{rownumend} 
			    
    
    </select>

	<select id="getTrainInfoTotalCount" parameterType="map" resultType="map">
	  select count(*) as count from jhpt_rjh.m_trainlinetemp t where 1=1  AND t.scheme_id = #{chartId}
	 	<if test="trainNbr != null">
			AND t.name like '%' || #{trainNbr} || '%'
		</if>
		<if test="startBureauShortName != null">
		   AND t.source_bureau_shortname = #{startBureauShortName}
		</if> 
		<if test="endBureauShortName != null">
		   AND t.target_bureau_shortname = #{endBureauShortName}
		</if>
	</select>
	
	<select id="getTrainInfo"  parameterType="map" resultType="org.railway.com.trainplan.entity.PlanTrain">
	    select id as planTrainId,
	    name as trainNbr,
        source_node_name as startStn, 
        target_node_name as endStn,
        source_bureau_shortname as startBureauShortName, 
        target_bureau_shortname as endBureau,
        route_bureau_shortnames as routingBureauShortName,
        relative_target_time_day as relativeTargetTimeDay,
        source_bureau_name as startBureauFull,
        target_bureau_name as endBureauFull,
        to_char(source_time,'hh24:mi:ss') as startTimeStr,
        to_char(target_time,'hh24:mi:ss')  as endTimeStr,
        operation as operation
        from jhpt_rjh.m_trainlinetemp t where 1=1  AND t.scheme_id = #{chartId}
    	<if test="trainNbr != null">
			AND t.name= #{trainNbr}
		</if>
		<if test="operation != null">
			AND t.operation= #{operation}
		</if>
		<if test="startBureau != null">
		   AND t.source_bureau_shortname = #{startBureauShortName}
		</if> 
		<if test="startBureau != null">
		   AND t.target_bureau_shortname = #{endBureauShortName}
		</if>
		   order by trainNbr
	</select>
	
	<select id="getTrainInfoForPage"  parameterType="map" resultType="org.railway.com.trainplan.entity.PlanTrain">
	    select * from (select ROWNUM AS num, m.*  from  
	    ( 
		select id as planTrainId,
		name as trainNbr,
        source_node_name as startStn, 
        target_node_name as endStn,
        source_bureau_shortname as startBureau, 
        target_bureau_shortname as endBureau,
        route_bureau_shortnames as routingBureauShortName,
        relative_target_time_day as relativeTargetTimeDay,
        source_bureau_name as startBureauFull,
        target_bureau_name as endBureauFull,
        to_char(source_time,'hh24:mi:ss') as startTimeStr,
        to_char(target_time,'hh24:mi:ss')  as endTimeStr,
        operation as operation
        from jhpt_rjh.m_trainlinetemp t where 1=1  AND t.scheme_id = #{chartId}
    	<if test="trainNbr != null">
			AND t.name like '%' || #{trainNbr} || '%'
		</if>
		<if test="startBureauShortName != null">
		   AND t.source_bureau_shortname = #{startBureauShortName}
		</if> 
		<if test="endBureauShortName != null">
		   AND t.target_bureau_shortname = #{endBureauShortName}
		</if>
		   order by trainNbr
		 ) m  ) where num >=#{rownumstart} AND num &lt;=#{rownumend} 
		
	</select>
	

</mapper>